<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>chatroom.html</title>

    <meta name="keywords" content="keyword1,keyword2,keyword3">
    <meta name="description" content="this is my page">
    <meta name="content-type" content="text/html" charset="UTF-8">
    <!--<link rel="stylesheet" type="text/css" href="./styles.css">-->
    <!-- 独立css -->
    <link rel="stylesheet" type="text/css" th:href="@{/css/chatroom.css}">
    <!-- 引入样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- 引入样式文件 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vant@2.12/lib/index.css"/>
    <style>
        .text {
            font-size: 14px;
        }

        .item {
            margin-bottom: 18px;
        }

        .clearfix:before,
        .clearfix:after {
            display: table;
            content: "";
        }

        .clearfix:after {
            clear: both
        }

        .box-card {
            width: 480px;
        }
    </style>

</head>

<body>
<div id="app">
    <el-row>
        <el-col :span="8"></el-col>
        <el-col :span="8">
            <div v-if="showNameInput" style="margin-top: 15px;">
                <el-input placeholder="请输入昵称" v-model="userName" class="input-with-select">
                    <el-button slot="append" icon="el-icon-thumb" @click="closeNameInput"></el-button>
                </el-input>
            </div>

            <el-card class="box-card">
                <div v-for="obj in massMsg" class="text item">
                    {{obj}}
                </div>
                <div slot="header" class="clearfix">
                    <span>
                        <el-input placeholder="请输入内容" v-model="msg" class="input-with-select"></el-input>
                    </span>
                        <el-button style="float: right; padding: 3px 0" type="text" @click="sendMassMessage">发送</el-button>
                </div>
            </el-card>
        </el-col>
        <el-col :span="8"></el-col>
    </el-row>

    <van-row type="flex" justify="space-between">
        <van-col span="1">span: 1</van-col>
        <van-col span="10">span: 10</van-col>
        <van-col span="1">span: 1</van-col>
    </van-row>
</div>
<!-- import Vue before Element -->
<script src="https://unpkg.com/vue/dist/vue.js"></script>
<!-- import JavaScript -->
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vant@2.12/lib/vant.min.js"></script>
<!-- 独立JS -->
<script th:src="@{/js/jquery.min.js}"></script>
<script th:src="@{/js/sockjs.min.js}"></script>
<script th:src="@{/js/stomp.js}"></script>
<script>
    new Vue({
        el: '#app',
        data: {
            userName: '',
            msg: '',
            massMsg: [],
            address: 'test1',
            reqMsg: '',
            massReq: {
                msg: '',
                name: ''
            },
            showNameInput: true,
            stompClient: ''
        },
        methods: {
            initWebSocket() {
                this.connect();
            },
            //打开双通道
            connect() {
                console.log("打开双通道");
                let socket = new SockJS('http://127.0.0.1:8080/endpointOyzc'); //连接SockJS的endpoint名称为"endpointAric"
                this.stompClient = Stomp.over(socket);//使用STMOP子协议的WebSocket客户端
                let that = this;
                this.stompClient.connect({}, function (frame) {//连接WebSocket服务端
                    console.log('Connected:' + frame);
                    //广播接收信息
                    that.stompTopic();
                });
            },
            disconnect() {
                if (this.stompClient != null) {
                    this.stompClient.disconnect();
                }
                console.log("Disconnected");
            },
            //广播（一对多）
            stompTopic() {
                //通过stompClient.subscribe订阅/topic/getResponse 目标(destination)发送的消息（广播接收信息）
                this.stompClient.subscribe(`/mass/${this.address}`,(response)=>{
                    console.log("11111222222");
                    console.log(this);
                    let json = JSON.parse(response.body);
                    //展示广播的接收的内容接收
                    this.reqMsg = json.name + ": " + json.msg;
                    this.massMsg.push(this.reqMsg);
                });
            },
            //群聊
            sendMassMessage(){
                this.massReq.name = this.userName;
                this.massReq.msg = this.msg;
                this.stompClient.send(`/mass/${this.address}`,{},JSON.stringify(this.massReq));
                this.msg = '';
            },
            closeNameInput(){
                console.log(this.userName+"--username");
                this.showNameInput = false;
            }
        },
        beforeDestroy() {
            // 页面离开时断开连接,清除定时器
            this.disconnect();
        },
        mounted() {
            this.initWebSocket();
        },
    });

    // 通过 CDN 引入时不会自动注册 Lazyload 组件
    // 可以通过下面的方式手动注册
    Vue.use(vant.Lazyload);
</script>
</body>
</html>
